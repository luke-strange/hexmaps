/**
	Open Innovations tool for making hex maps
	Version 2
	
	Things to do:
		* search tool to highlight hexes (top left)
		* load layout from CSV/Google Sheet
		* draw boundaries
		* button to switch layout
		* drag on touch screen when over hexagons but none selected
 */
!function(e){var t=e.OI||{};function n(e){e||(e={});var n=new t.logger("HexBuilder v2",{el:document.getElementById("messages"),visible:["info","warning","error"],fade:6e4,class:"msg"}),l=this,a={canvas:e.canvas||document.getElementById("canvas"),zoom:e.zoom||document.getElementById("zoom"),main:document.getElementById("main"),head:document.querySelector("header"),foot:document.querySelector("footer"),nav:document.querySelector("nav"),open:document.getElementById("dialog-open"),hexes:document.querySelector(".data-layer .series")};this.show={info:!0},this.selectedHexes=[],this.query={},this.saveable="function"==typeof Blob,this.touchable="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;var c=parseFloat(a.zoom.getAttribute("min")),y=parseFloat(a.zoom.getAttribute("max")),x=!1,w=!1,B=!1,H=0,k=null,S=-1,L=new Date,E=null;for(str=location.search.substr(1),bits=str.split(/\&/),b=0;b<bits.length;b++)0==bits[b].indexOf("http")||-1==bits[b].indexOf("=")?this.query.url=bits[b]:(kv=bits[b].split(/=/),kv[1]=decodeURI(kv[1]),"true"==kv[1]&&(kv[1]=!0),"false"==kv[1]&&(kv[1]=!1),this.query[kv[0]]=kv[1]);function q(e){var t,i;l.touchable?(t=e.touches[0].clientX,i=e.touches[0].clientY):(t=e.clientX,i=e.clientY),k&&(l.panBy(t-k.x,i-k.y),l.updateView()),k={x:t,y:i},l.touchable||l.updateSelectionBorder()}return this.reset=function(){return this},this.resize=function(){return n.log("resize",this.wide,this.tall),this.updateView()},this.updateView=function(){return this.display.updateViewBox(),this.nav&&(document.getElementById("btn-save").disabled=!(this.display.hexes.length>0),document.getElementById("btn-labels").disabled=!(this.display.hexes.length>0),document.getElementById("btn-selectall").disabled=!(this.display.hexes.length>0),document.getElementById("btn-deselect").disabled=0==this.selectedHexes.length,document.getElementById("btn-removeall").disabled=0==this.display.hexes.length,document.getElementById("btn-removeselect").disabled=0==this.selectedHexes.length,document.getElementById("btn-colour").style.display=0==this.selectedHexes.length?"none":"",document.getElementById("btn-selectcolour").disabled=0==this.selectedHexes.length,document.getElementById("btn-deselectcolour").disabled=0==this.selectedHexes.length,document.getElementById("btn-info").disabled=0==this.display.hexes.length),this.setHeight(),this},this.updateSelectedColour=function(e){return document.getElementById("colourpicker-label").style["background-color"]=e,document.querySelectorAll(".selected-colour").forEach(function(t){t.style["background-color"]=e}),this},this.init=function(){n.log("init"),this.touchable&&document.body.classList.add("touchable"),e.hex={},this.touchable?e.hex.on={touchstart:function(e){1==(H=e.touches.length)&&(e.preventDefault(),e.stopPropagation()),L=new Date,E=this,this.isSelected()?l.clearInfo():l.setHovered(this).setInfo(this)},touchmove:function(e){if(!B&&1==H&&(x=!0,l.selectedHexes.length>0&&E&&E.isSelected()&&(w=!0),w)){if(k){var t=l.display.screenToRQ({x:e.touches[0].clientX,y:e.touches[0].clientY});l.moveTo(t),l.updateSelectionBorder()}k={x:e.touches[0].clientX,y:e.touches[0].clientY}}},touchend:function(e){new Date-L<500&&(B||1!=H||(w&&(e.preventDefault(),e.stopPropagation()),w||(this.isSelected()?(l.deselectHex(this).updateView(),this.toFront()):(l.selectHex(this).updateView(),this.toBack())))),w=!1,x=!1,E=null}}:e.hex.on={mouseover:function(e){x||(e.preventDefault(),e.stopPropagation(),l.setHovered(this),l.setInfo(this),this.toFront())},mousedown:function(e){e.preventDefault(),e.stopPropagation(),E=this,x=!0,L=new Date},mousemove:function(e){l.selectedHexes.length>0&&this&&this.isSelected()&&x&&(w=!0)},mouseup:function(e){e.preventDefault(),e.stopPropagation(),new Date-L<500&&(e.ctrlKey?this.isSelected()?(l.deselectHex(this).updateView(),this.toFront()):(l.selectHex(this).updateView(),this.toBack()):(l.deselectAllHexes(),l.selectHex(this).updateView(),this.toBack())),x=!1,w=!1,E=null},mouseout:function(e){e.preventDefault(),e.stopPropagation(),l.setHovered(),this.isSelected()||l.clearInfo()}},e.resize=function(e){a.foot.style["max-height"]=e+"px"},this.display=new function(e,s){s||(s={});var n,l,a=new t.logger("HexDisplay v2",{el:document.getElementById("messages"),visible:["info","warning","error"],fade:6e4,class:"msg"}),c=e.parentElement;this.layout="odd-r",this.wide=c.offsetWidth,this.tall=c.offsetHeight,this.centre={x:this.wide/2,y:this.tall/2},this.showlabels=!1,this.showgrid="boolean"!=typeof s.grid||s.grid,this.scale=1,this.hexes=[];function y(e){return!!(!0&e)}function x(e){return!(!0&e)}return this.init=function(){a.log("init"),this.setLayout(this.layout);var t=e.querySelector(".data-layer");return t||((t=v("g","svg")).setAttribute("role","table"),t.classList.add("data-layer"),e.append(t)),l||((l=v("g","svg")).setAttribute("role","row"),l.classList.add("series"),t.append(l)),this},this.setScale=function(e){return this.scale=e,this.updateViewBox()},this.setLayout=function(e){return this.layout=e,this.updateGrid(),this},this.updateViewBox=function(){var t=this.wide*this.scale,i=this.tall*this.scale,s=this.centre.x-this.scale*this.wide/2,o=this.centre.y-this.scale*this.tall/2;return e.setAttribute("viewBox",s.toFixed(2)+" "+o.toFixed(2)+" "+t.toFixed(2)+" "+i.toFixed(2)),n&&(n.setAttribute("x",s.toFixed(2)),n.setAttribute("y",o.toFixed(2))),this},this.toggleGrid=function(){return this.showgrid=!this.showgrid,this.updateGrid()},this.updateGrid=function(){var t,i,s;return(s=e.querySelector("defs"))||(s=v("defs","svg"),e.prepend(s)),t=e.getElementById("pattern-q"),i=e.getElementById("pattern-r"),t||(t=v("pattern","svg"),s.append(t)),i||(i=v("pattern","svg"),s.append(i)),n||(n=e.getElementById("grid")),n||(p(n=v("rect","svg"),{id:"grid",x:"-50%",y:"-50%",fill:"url(#pattern-r)",width:"100%",height:"100%"}),e.prepend(n)),this.showgrid?(p(t,{id:"pattern-q",width:3*o,height:2*r,patternUnits:"userSpaceOnUse"}),t.innerHTML='<path stroke="#cbd5e1" stroke-width="0.7" d="M'+2*o+" 0H"+o+"L"+o/2+" "+r+"l"+o/2+" "+r+"h"+o+"l"+o/2+"-"+r+"zM150 "+r+"h"+o/2+"M0 "+r+"h"+o/2+'" fill="none"  vector-effect="non-scaling-stroke" />',p(i,{id:"pattern-r",width:2*r,height:3*o,patternUnits:"userSpaceOnUse"}),i.innerHTML='<path stroke="#cbd5e1" stroke-width="0.7" d="M'+r+" "+o/2+"v-"+o/2+"m0 "+o/2+"l"+r+" "+o/2+"v"+o+"l-"+r+" "+o/2+"v"+o/2+"m0 -"+o/2+"l-"+r+" -"+o/2+" v-"+o+"l"+r+" -"+o/2+'" fill="none"  vector-effect="non-scaling-stroke" />'):(t.innerHTML="",i.innerHTML=""),n.setAttribute("fill",this.layout.indexOf("-r")>0?"url(#pattern-r)":"url(#pattern-q)"),this},this.setHeight=function(e){return c.style["max-height"]=e+"px",this.wide=c.offsetWidth,this.tall=c.offsetHeight,this.updateViewBox(),"function"==typeof s.resize&&s.resize.call(this,e),this},this.addHexJSON=function(e){for(h in this.setLayout(e.layout),e.hexes)e.hexes[h].id=h,this.addHex(e.hexes[h],s.hex);return this},this.screenToCanvas=function(e){var t=this.centre.x-this.scale*this.wide/2,i=this.centre.y-this.scale*this.tall/2,s=c.getBoundingClientRect();return e.y-=s.y,e.x-=s.x,{x:t+e.x*this.scale,y:i+e.y*this.scale}},this.screenToRQ=function(e){var t=this.screenToCanvas(e);return u(t.x,t.y,this.layout)},this.zoomToBBox=function(){var e,t,i,s,o=null;return(e=l.getBoundingClientRect()).width>0&&(t=n.getBoundingClientRect(),i=e.x-t.x,s=e.y-t.y,this.centre.x+=(i+e.width/2-this.wide/2)*this.scale,this.centre.y+=(s+e.height/2-this.tall/2)*this.scale,o=Math.max(e.height/(t.height-32),e.width/(t.width-32))),this.scale*o},this.removeHex=function(e){return e>=0&&e<this.hexes.length&&(h=this.hexes.splice(e,1),h[0].remove()),this.updateView()},this.addHex=function(e,t){e||(e={}),e.layout=this.layout;var i=new function(e,t){var i,s,n,l,a;e||(e={}),t||(t={}),this.hex=null,this.getDom=function(){return i},this.addTo=function(e){return e.appendChild(i),l=e,this},this.remove=function(){return i.remove(),this},this.setCoords=function(t,s){var n=f(t,s,e.layout);return i.setAttribute("transform","translate("+n.x+" "+n.y+")"),i.setAttribute("data-q",t),i.setAttribute("data-r",s),this.hex=g(t,s),this},this.setText=function(e){if("length"in e||(e=[e]),0==e.length)return this;var t,i,s=o/3,l="",r=o/4;for(t=0,i=-(e.length-1)*s/2;t<e.length;t++,i+=s)l+='<tspan class="'+(e[t].class||"")+'" x="0" y="'+i+'" font-size="'+r+'">'+e[t].text+"</tspan>";return n.innerHTML=l,this},this.showLabel=function(){var t,i,s;if(!n.innerHTML){if(e.n){if(t=[],i=function(e,t){var i,s,n=[],o="";for(s=0;s<e.length;s++)ch=e[s],(" "==ch||"-"==ch)&&o.length>t?(i="",o.indexOf(" ")>=0&&(i=o.substr(o.lastIndexOf(" ")+1),o=o.substr(0,o.lastIndexOf(" "))),n.push(o),o="",i&&(o+=i+" ")):o+=ch,s==e.length-1&&(o.length>t&&(i="",o.indexOf(" ")>=0&&(i=o.substr(o.lastIndexOf(" ")+1),o=o.substr(0,o.lastIndexOf(" "))),n.push(o),o="",i&&(o+=i+" ")),n.push(o));for(s=0;s<n.length;s++)n[s].length>t&&(n[s]=n[s].substr(0,t-2)+"â€¦");return n}(e.n,11))for(s=0;s<i.length;s++)t.push({text:i[s]})}else t=[{text:"q:"+this.hex.q,class:"on q"},{text:"r:"+this.hex.r,class:"on r"}];this.setText(t)}return n.style.display="",this},this.hideLabel=function(){return n.style.display="none",this},this.getOpts=function(){return e},this.toFront=function(){return l&&l.appendChild(i),this},this.toBack=function(){return l&&l.prepend(i),this},this.isSelected=function(){return h},this.select=function(){return h=!0,i.classList.add("selected"),this},this.deselect=function(){return h=!1,i.classList.remove("selected"),i.classList.remove("hovered"),this},this.getColour=function(){return a},this.setColour=function(e){return a=e||"#ccc",s.setAttribute("fill",a),e&&(s.setAttribute("stroke-width","0.75"),s.setAttribute("stroke",e)),this},i=v("g","svg"),s=v("path","svg"),n=v("text","svg"),i.appendChild(s),i.appendChild(n),i.classList.add("hex"),i.setAttribute("role","cell"),i.setAttribute("aria-label",e.n||e.name),s.setAttribute("vector-effect","non-scaling-stroke"),s.setAttribute("d",d),s.setAttribute("transform",e.layout.indexOf("-r")>0?"rotate(0)":"rotate(30)"),s.setAttribute("transform-origin",r+","+o),this.setColour(e.fill||e.colour),e.id&&(s.setAttribute("data-id",e.id),this.id=e.id),n.setAttribute("dominant-baseline","central"),n.setAttribute("text-anchor","middle"),n.setAttribute("x","0"),n.setAttribute("y","0");var h=!1;if(t.on)for(var c in t.on)m(c,i,{me:this,type:c},function(e){t.on[e.data.type].call(e.data.me,e)});return"number"==typeof e.q&&"number"==typeof e.r&&this.setCoords(e.q,e.r),this}(e,t);return this.hexes.push(i),i.addTo(l),this},this.toggleLabels=function(){for(this.showlabels=!this.showlabels,a.log("toggleLabels",this.showlabels),i=0;i<this.hexes.length;i++)this.showlabels?this.hexes[i].showLabel():this.hexes[i].hideLabel();return this},this.panBy=function(e,t){return this.centre.x-=e*this.scale,this.centre.y-=t*this.scale,this},this.shiftHex=function(e,t){var i,s,n;return n=this.layout,i=t.b.q-t.a.q,s=t.b.r-t.a.r,"odd-r"==n?(x(t.a.r)&&y(t.b.r)&&y(e.hex.r)&&i++,y(t.a.r)&&x(t.b.r)&&x(e.hex.r)&&i--):"even-r"==n?(x(t.a.r)&&y(t.b.r)&&y(e.hex.r)&&i--,y(t.a.r)&&x(t.b.r)&&x(e.hex.r)&&i++):"odd-q"==n?(x(t.a.q)&&y(t.b.q)&&y(e.hex.r)&&s++,y(t.a.q)&&x(t.b.q)&&x(e.hex.q)&&s--):"even-q"==n&&(x(t.a.q)&&y(t.b.q)&&y(e.hex.r)&&s--,y(t.a.q)&&x(t.b.q)&&x(e.hex.q)&&s++),e.setCoords(e.hex.q+i,e.hex.r+s),e.hex},this.getXY=function(e,t){return f(e,t,this.display.layout)},this.getRQ=function(e,t){return u(e,t,this.display.layout)},this.zoomAround=function(e,t,i){return null==e&&(e=this.wide/2),null==t&&(t=this.tall/2),this.centre.x+=(e-this.wide/2)*this.scale-(e-this.wide/2)*i,this.centre.y+=(t-this.tall/2)*this.scale-(t-this.tall/2)*i,this},this}(a.canvas,e),this.display.init(),this.setScale(parseFloat(a.zoom.value)),window.addEventListener("resize",function(){l.resize()}),this.nav=new t.NavBar(document.getElementById("navigation"),{id:"mainmenu"}),this.nav.add({id:"menu-file",text:"File"}),this.nav.add({id:"menu-edit",text:"Edit"}),this.nav.add({id:"menu-view",text:"View"}),this.nav.add({id:"btn-colour",text:'<input type="color" id="colourpicker"><label for="colourpicker" style="text-indent: -9999px;" title="Change colour of selected hexes" id="colourpicker-label">Change colour</label>',on:{init:function(e){document.getElementById("colourpicker").addEventListener("change",function(e){l.updateSelectedColour(e.target.value),l.setSelectedColour(e.target.value)})}}}),this.nav.getItem("menu-file").add({id:"btn-open",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.825a2 2 0 0 1-1.991-1.819l-.637-7a2 2 0 0 1 .342-1.31L.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3m-8.322.12q.322-.119.684-.12h5.396l-.707-.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981z"/></svg>',text:"Open HexJSON",key:"Ctrl + O",on:{init:function(e,t){function i(){s.classList.remove("drop")}document.querySelectorAll(".btn-open").forEach(function(e){e.addEventListener("click",function(){l.toggleOpenDialog()})}),document.getElementById("reset").addEventListener("click",function(e){document.getElementById("standard_files").value="",l.reset()}),document.getElementById("btnSubmit").addEventListener("click",function(e){e.preventDefault();var t=document.getElementById("no-file");t&&t.remove();var i=document.getElementById("standard_files").files[0];if(i)l.readFile(i);else{var s=document.getElementById("url").value;s?l.getURL(s):n.warn("No input HexJSON provided. Please provide a URL or a file.",{id:"no-file"})}}),document.getElementById("url").addEventListener("change",function(e){l.getURL(e.target.value)});var s=document.getElementById("drop_zone");s.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault(),s.classList.add("drop")},!1),s.addEventListener("dragout",i,!1),document.getElementById("standard_files").addEventListener("change",function(e){i(),l.updateFileDetails()});for(var o=document.querySelectorAll("a.example"),r=0;r<o.length;r++)o[r].addEventListener("click",function(e){e.preventDefault(),document.getElementById("url").value=e.target.getAttribute("href"),document.getElementById("btnSubmit").click()})},click:function(){l.toggleOpenDialog()}}}).add({id:"btn-save",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"></path><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"></path></svg>',text:"Save HexJSON",key:"Ctrl + S",on:{click:function(){l.saveHexJSON()}}}),this.nav.getItem("menu-edit").add({id:"btn-selectcolour",icon:'<div class="selected-colour box" style="background:black;"></div>',text:"Select hexes by colour",key:"c",on:{click:function(){l.selectBySameColour()}}}).add({id:"btn-deselectcolour",icon:'<div class="selected-colour box" style="background:black;"></div>',text:"Deselect by colour",key:"Shift + C",on:{click:function(){l.deselectBySameColour()}}}).add({id:"btn-selectall",text:"Select all",key:"Ctrl + A",on:{click:function(){l.selectAllHexes()}}}).add({id:"btn-deselect",text:"Deselect all",key:"Ctrl + D",on:{click:function(){l.deselectAllHexes()}}}).addSeparator().add({id:"btn-removeselect",text:"Delete selected hexes",key:"Delete",on:{click:function(){l.removeSelectedHexes()}}}).add({id:"btn-removeall",text:"Delete all hexes",key:"Ctrl + Delete",on:{click:function(){l.removeAllHexes()}}}),this.nav.getItem("menu-view").add({icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11M13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0"/><path d="M10.344 11.742q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1 6.5 6.5 0 0 1-1.398 1.4z"/><path d="M6.5 3a.5.5 0 0 1 .5.5V6h2.5a.5.5 0 0 1 0 1H7v2.5a.5.5 0 0 1-1 0V7H3.5a.5.5 0 0 1 0-1H6V3.5a.5.5 0 0 1 .5-.5" /></svg>',text:"Zoom in",key:"+",on:{click:function(e){l.zoomIn()}}}).add({icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11M13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0"/><path d="M10.344 11.742q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1 6.5 6.5 0 0 1-1.398 1.4z"/><path d="M3 6.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5" /></svg>',text:"Zoom out",key:"-",on:{click:function(e){l.zoomOut()}}}).add({id:"btn-zoomtobbox",icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11M13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0"/><path d="M10.344 11.742q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1 6.5 6.5 0 0 1-1.398 1.4z"/><path d="M6.5 6.5m2 -2l-1.5 0 0 -1 2.5 0 0 2.5 -1 0zM6.5 6.5m2 2l0 -1.5 1 0 0 2.5 -2.5 0 0 -1zM6.5 6.5m-2 2l1.5 0 0 1 -2.5 0 0 -2.5 1 0zM6.5 6.5m-2 -2l0 1.5 -1 0 0 -2.5 2.5 0 0 1z" /></svg>',text:"Zoom to fit",key:"f",on:{click:function(){l.zoomToBBox()}}}).addSeparator().add({id:"btn-labels",text:"Toggle hexagon labels",key:"l",on:{click:function(){l.toggleLabels()}}}).add({id:"btn-grid",text:"Toggle grid",key:"g",on:{click:function(){l.toggleGrid()}}}).add({id:"btn-info",text:"Toggle hexagon information",key:"i",on:{click:function(){l.toggleInfo()}}}),zoom.addEventListener("input",function(e){e.preventDefault(),l.zoomAround(null,null,parseFloat(a.zoom.value))}),a.canvas.addEventListener("wheel",function(e){e.preventDefault();var t=a.main.getBoundingClientRect();l.zoomAround(e.clientX-t.x,e.clientY-t.y,parseFloat(a.zoom.value)*(e.deltaY>0?1.25:.8))}),this.touchable?(a.canvas.addEventListener("touchstart",function(e){e.preventDefault(),e.stopPropagation(),w||(H=e.touches.length,B=!0)}),a.canvas.addEventListener("touchmove",function(e){e.preventDefault(),e.stopPropagation(),w||(2==H?function(e){var t,i,s,n,o,r;t=[e.touches[0].clientX,e.touches[1].clientX],i=[e.touches[0].clientY,e.touches[1].clientY],s=Math.abs(t[0]-t[1]),n=Math.abs(i[0]-i[1]),o=Math.sqrt(s*s+n*n),r=a.main.getBoundingClientRect(),S>0&&l.zoomAround((t[0]+t[1])/2-r.x,(i[0]+i[1])/2-r.y,parseFloat(a.zoom.value)*(S/o)),S=o}(e):1==H&&q(e))}),a.canvas.addEventListener("touchend",function(e){w||(k=null,B=!1,S=-1,l.updateSelectionBorder())})):(a.canvas.addEventListener("mousedown",function(e){e.preventDefault(),e.stopPropagation(),w||(x=!0,a.canvas.classList.add("dragging"))}),a.canvas.addEventListener("mousemove",function(e){if(e.preventDefault(),e.stopPropagation(),x)if(w){var t=l.display.screenToRQ({x:e.clientX,y:e.clientY});l.moveTo(t),l.updateSelectionBorder()}else q(e)}),a.canvas.addEventListener("mouseup",function(e){e.preventDefault(),e.stopPropagation(),x&&(x=!1),w=!1,k=null,l.updateSelectionBorder(),a.canvas.classList.remove("dragging")})),document.addEventListener("keydown",function(e){e.stopPropagation(),console.log(e.key),"c"==e.key?l.selectBySameColour():"c"==e.key.toLowerCase()&&e.shiftKey?l.deselectBySameColour():"a"==e.key&&e.ctrlKey?(e.preventDefault(),l.selectAllHexes()):"a"==e.key.toLowerCase()&&e.ctrlKey&&e.shiftKey||"d"==e.key&&e.ctrlKey||"Escape"===e.key?(e.preventDefault(),l.deselectAllHexes()):"f"==e.key?l.zoomToBBox():"g"==e.key?l.toggleGrid():"i"==e.key?l.toggleInfo():"l"==e.key?l.toggleLabels():"o"==e.key&&e.ctrlKey?(e.preventDefault(),l.toggleOpenDialog()):"s"==e.key&&e.ctrlKey?(e.preventDefault(),l.saveHexJSON()):"+"==e.key?l.zoomIn():"-"==e.key?l.zoomOut():"Delete"!=e.key&&"Backspace"!=e.key||(e.ctrlKey?l.removeAllHexes():l.removeSelectedHexes())});var s=document.createElement("div");return s.classList.add("about"),s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/></svg>',s.addEventListener("click",function(e){l.toggleAbout()}),document.querySelector("header").append(s),this.toggleAbout(),this.setHeight(),this.updateView(),this.query.url&&this.getURL(this.query.url),this},this.setHovered=function(e){for(var t=a.canvas.querySelectorAll(".hovered"),i=0;i<t.length;i++)t[i].classList.remove("hovered");return e&&e.getDom().classList.add("hovered"),this},this.panBy=function(e,t){return this.display.panBy(e,t),this},this.toggleGrid=function(){return this.display.toggleGrid(),this.updateView(),this},this.toggleLabels=function(){return this.display.toggleLabels(),this.updateView(),this},this.setHeight=function(){var e=window.innerHeight-a.head.offsetHeight-a.nav.offsetHeight;return this.display.setHeight(e),this},this.zoomToBBox=function(){return s=this.display.zoomToBBox(),this.setScale(s),this},this.updateSelectionBorder=function(){return this.mergedBorder(this.selectedHexes,this.display.layout)},this.selectHexAt=function(e,t){for(var i=-1,s=0;s<this.display.hexes.length;s++)this.display.hexes[s].hex.q==e&&this.display.hexes[s].hex.r==t&&(i=s);return i>=0?this.selectHex(this.display.hexes[i]):n.error("No matching hex for "+e+","+t),this},this.selectHex=function(e,t){return e.select(),this.selectedHexes.indexOf(e)<0&&this.selectedHexes.push(e),t||this.updateSelectionBorder(),this.updateSelectedColour(e.getColour()),this},this.deselectHex=function(e,t){e.deselect();var i=this.selectedHexes.indexOf(e);return i>=0?this.selectedHexes.splice(i,1):n.warn("No hexagon to deselect"),t||this.updateSelectionBorder(),this},this.selectBySameColour=function(){if(this.selectedHexes.length>0){var e=this.selectedHexes.splice(this.selectedHexes.length-1,1)[0],t=e.getColour();for(h=0;h<this.display.hexes.length;h++)this.display.hexes[h].getColour()==t&&this.display.hexes[h]!=e&&(this.selectHex(this.display.hexes[h],!0),this.display.hexes[h].toFront());this.selectedHexes.push(e),this.updateSelectedColour(t)}else n.warn("No hexagon selected.");return this.updateSelectionBorder(),this.updateView()},this.deselectBySameColour=function(){if(this.selectedHexes.length>0){var e=this.selectedHexes[this.selectedHexes.length-1].getColour();for(h=this.selectedHexes.length-1;h>=0;h--)this.selectedHexes[h].getColour()==e&&this.deselectHex(this.selectedHexes[h],!0)}else n.warn("No hexagon selected.");return this.updateSelectionBorder(),this.updateView()},this.selectAllHexes=function(){for(h=0;h<this.display.hexes.length;h++)this.display.hexes[h].isSelected()||(this.display.hexes[h].select(),this.selectedHexes.push(this.display.hexes[h]));return document.getElementById("btn-deselect").disabled=!1,this.updateSelectionBorder(),this.updateView()},this.deselectAllHexes=function(){for(h=0;h<this.display.hexes.length;h++)this.display.hexes[h].deselect();return this.selectedHexes=[],document.getElementById("btn-deselect").disabled=!0,this.updateSelectionBorder(),this.updateView()},this.removeAllHexes=function(){for(h=0;h<this.display.hexes.length;h++)this.display.hexes[h].remove();return this.display.hexes=[],this.selectedHexes=[],document.getElementById("btn-removeall").disabled=!0,this.updateSelectionBorder(),this.updateView()},this.removeSelectedHexes=function(){var e;if(0==this.selectedHexes.length)return this;for(var t=0;t<this.selectedHexes.length;t++)(e=this.display.hexes.indexOf(this.selectedHexes[t]))>=0&&(this.display.hexes[e].remove(),this.display.hexes.splice(e,1));return this.selectedHexes=[],this.updateSelectionBorder(),this.updateView()},this.moveTo=function(e){if(this.selectedHexes.length>0){var t=E||this.selectedHexes[this.selectedHexes.length-1];shift={a:t.hex,b:e};for(var i=0;i<this.selectedHexes.length;i++)shift.b.q==shift.a.q&&shift.b.r==shift.a.r||this.display.shiftHex(this.selectedHexes[i],shift)}},this.updateFileDetails=function(){n.log("Update file details",document.getElementById("standard_files").files);var e,t=document.getElementById("standard_files"),i="";if(t.files&&t.files[0]){var s=t.files[0];i="File: <em>"+s.name+"</em><br />Size: "+((e=s.size)>1e12?(e/1e12).toFixed(2)+" TB":e>1e9?(e/1e9).toFixed(2)+" GB":e>1e6?(e/1e6).toFixed(2)+" MB":e>1e3?(e/1e3).toFixed(2)+" kB":e+" bytes")}return document.querySelector("#drop_zone .info").innerHTML=i,this},this.readFile=function(e){n.log("readFile",e);var t=new FileReader;return t.readAsText(e,"UTF-8"),t.addEventListener("load",function(e){var t=JSON.parse(e.target.result);l.addHexJSON(t),l.setVisible("map")}),t.onerror=function(e){n.error("Failed to read file")},this},this.getURL=function(e){return e&&(n.log("getURL",e),fetch(e,{}).then(e=>{if(!e.ok)throw new Error("Network response was not OK");return e.json()}).then(e=>{this.addHexJSON(e),this.setVisible("map")}).catch(t=>{n.error("There has been a problem loading CSV data from <em>%c"+e+"%c</em>. It may not be publicly accessible or have some other issue.","font-style:italic;","font-style:normal;")})),this},this.saveHexJSON=function(){var e,t;t="test.json",this.query.url&&(t=this.query.url),document.getElementById("url").value&&(t=document.getElementById("url").value),document.getElementById("standard_files").files.length>0&&(t=document.getElementById("standard_files").files[0].name),t=t.replace(/.*\/([^\/])/,function(e,t){return t}),e=(e=JSON.stringify(this.getHexJSON())).replace(/\{\"layout\"/,'{\n\t"layout"').replace(/\,\"(version|boundaries|hexes)\":([\{]?)/g,function(e,t,i){return',\n\t"'+t+'":'+(i?i+"\n\t\t":"")}).replace(/\}\,"([^\"]+)":\{/g,function(e,t){return'},\n\t\t"'+t+'":{'}).replace(/\}\}\,/,"}\n\t},").replace(/\}\}$/,"\n\t}\n}");var i=new Blob([e],{type:"text/json"}),s=t;var n=document.createElement("a");return n.download=s,n.innerHTML="Download File",null!=window.webkitURL?n.href=window.webkitURL.createObjectURL(i):(n.href=window.URL.createObjectURL(i),n.onclick=function(e){document.body.removeChild(e.target)},n.style.display="none",document.body.appendChild(n)),n.click(),this},this.getHexJSON=function(){var e,t,i,s;for((t=JSON.parse(JSON.stringify(this.hexjson))).hexes={},t.layout=this.display.layout,e=0;e<this.display.hexes.length;e++)s=(i=JSON.parse(JSON.stringify(this.display.hexes[e].getOpts()))).id,i.q=this.display.hexes[e].hex.q,i.r=this.display.hexes[e].hex.r,delete i.id,delete i.layout,t.hexes[s]=i;return t},this.addHexJSON=function(e){return this.hexjson=e,n.log("loadHexJSON",e),this.display.addHexJSON(e),this.display.showlabels&&this.display.hexes[this.display.hexes.length-1].showLabel(),setTimeout(function(){l.zoomToBBox().updateView()},100),this},this.setVisible=function(e){return a.main.style.display="map"==e?"block":"none",a.open.style.display="open"==e?"block":"none",a.foot.style.display="about"==e?"block":"none",this},this.toggleOpenDialog=function(){return n.log("toggle",window.getComputedStyle(document.getElementById("dialog-open")).display),"none"==window.getComputedStyle(document.getElementById("dialog-open")).display?this.setVisible("open"):this.setVisible("map"),this},this.setScale=function(e){return e=this.limitZoom(e),this.display.setScale(e),a.zoom.value=e,this.updateView()},this.limitZoom=function(e){return Math.max(c,Math.min(y,e))},this.zoomIn=function(e,t){return this.zoomAround(null,null,.8*parseFloat(a.zoom.value)),this},this.zoomOut=function(e,t){return this.zoomAround(null,null,1.25*parseFloat(a.zoom.value)),this},this.zoomAround=function(e,t,i){return i=this.limitZoom(i),a.zoom.value=i,this.display.zoomAround(e,t,i),this.setScale(i)},this.toggleAbout=function(){var e=window.getComputedStyle(a.foot).display;return this.setVisible("none"==e?"about":"map"),this},this.toggleInfo=function(){if(this.show.info=!this.show.info,this.show.info){var e=document.getElementById("hex-info");e&&(e.style.display="")}else this.clearInfo();return this},this.setInfo=function(e){var t=document.getElementById("hex-info");if(t&&this.show.info){var i,s=e.getOpts(),n="";for(i in n='<span class="value">'+(s.n||s.name)+"</span>",n+='<br /><span class="r">row (r)</span>: <span class="r">'+e.hex.r+'</span>, <span class="q">col (q)</span>: <span class="q">'+e.hex.q+"</span>",s)"n"!=i&&"r"!=i&&"q"!=i&&"layout"!=i&&"name"!=i&&(n+="<br />"+i+': <span class="value">'+s[i]+"</span>");t.innerHTML=n,t.style.display=""}return this},this.clearInfo=function(){var e=document.getElementById("hex-info");e&&(e.innerHTML="",e.style.display="none")},this.mergedBorder=function(e,t){var i,s,n,l,r,h,d,c,u,m={},y="";if((c=a.canvas.querySelector(".selection"))||((c=v("path","svg")).classList.add("selection"),a.canvas.append(c)),e&&e.length>0){for(i=0;i<e.length;i++)m[e[i].hex.id]={i:i,hex:e[i].hex,done:0,checked:[!1,!1,!1,!1,!1,!1]};for(n=function e(t,i,s,n,o){"object"!=typeof o&&(o=[[]]);"number"!=typeof n&&(n=0);var l,r,a,h;if(i[s].checked[n]){if(r=s,6==i[s].done){for(a=Object.keys(i),h=a.indexOf(s)+1;h<a.length&&6==i[a[h]].done;)h++;if(h>=a.length)return o;r=a[h]}for(l=0;l<6;l++)i[r].checked[l]||(o.push([]),o=e(t,i,r,l,o));return o}var d=i[s].hex.neighbours(t);r=d[n].id;i[s].checked[n]||(i[s].checked[n]=!0,i[s].done++);i[r]?o=e(t,i,r,(n-2+6)%6,o):(o[o.length-1].push({id:s,q:i[s].hex.q,r:i[s].hex.r,e:n+1}),o=e(t,i,s,(n+1)%6,o));return o}(t,m,e[0].hex.id),s=0;s<n.length;s++)for(u&&(y+=u+"z"),u="",i=0;i<n[s].length;i++)r=g((l=n[s][i]).q,l.r),h=f(l.q,l.r,t),d=r.edge(t,l.e),0==i&&(u+="M"+(h.x+d[0][0]*o)+" "+(h.y+d[0][1]*o)),u+="L"+(h.x+d[1][0]*o)+" "+(h.y+d[1][1]*o);u&&(y+=u+"z")}return p(c,{d:y,fill:"transparent","pointer-events":"none","vector-effect":"non-scaling-stroke"}),this},this.setSelectedColour=function(e){for(h=0;h<this.display.hexes.length;h++)this.display.hexes[h].isSelected()&&this.display.hexes[h].setColour(e);return this.updateView()},this.init()}t.ready||(t.ready=function(e){"loading"!=document.readyState?e():document.addEventListener("DOMContentLoaded",e)});var o=60,l=1.5*o,r=Math.round(o*Math.cos(30*Math.PI/180)),a=2*r,d="m0-"+o+"l"+r+","+o/2+",0,"+o+",-"+r+","+o/2+",-"+r+"-"+o/2+",0-"+o+","+r+"-"+o/2+"z",c=Math.sqrt(3);function u(e,t,i){var s,n;return"odd-r"==i?(s=Math.floor(-(2*t/c-r)/a),n=Math.floor((e+r)/a+(!0&s?-.5:0))):"even-r"==i&&(s=Math.floor(-(2*t/c-r)/a),n=Math.floor((e+r)/a+(!0&s?.5:0))),g(n,s)}function f(e,t,i){var s,n;return"odd-r"==i?(s=e*a+(!0&t?r:0),n=-t*l):"even-r"==i?(s=e*a+(!0&t?-r:0),n=-t*l):"odd-q"==i?(s=e*l,n=-(t*a+(!0&e?r:0))):"even-q"==i&&(s=e*l,n=-(t*a+(!0&e?-r:0))),{x:s,y:n}}function g(e,t){return new function(e,t){this.q=e,this.r=t,this.id=e+","+t;var i=Math.round(1e3*Math.sqrt(3)/2)/1e3;return this.neighbours=function(e){var t,i,s,n=[];return t=this.q,i=this.r,"odd-r"==e||"even-r"==e?(s=!0&i,"even-r"==e&&(s=!s),n=[g(s?t+1:t,i+1),g(t+1,i),g(s?t+1:t,i-1),g(s?t:t-1,i-1),g(t-1,i),g(s?t:t-1,i+1)]):"odd-q"==e||"even-q"==e?(s=!0&t,"even-q"==e&&(s=!s),n=[g(t,i+1),g(t+1,s?i:i+1),g(t+1,s?i-1:i),g(t,i-1),g(t-1,s?i-1:i),g(t-1,s?i:i+1)]):console.error("No layout type given"),n},this.edges=function(e){return e.indexOf("-r")>0?[[0,-1],[i,-.5],[i,.5],[0,1],[-i,.5],[-i,-.5]]:e.indexOf("-q")>0?[[-.5,-i],[.5,-i],[0,1],[.5,i],[-.5,i],[-1,0]]:(console.error("No layout type given"),[])},this.edge=function(e,t){var i,s,n;return this.q,this.r,i=this.edges(e),n=(1+(s=t-1))%i.length,t>0?[i[s],i[n]]:[i[n],i[s]]},this}(e,t)}function p(e,t){for(var i in t)e.setAttribute(i,t[i]);return e}function m(e,t,i,s){t.addEventListener(e,function(e){e.data=i,s.call(i.this||this,e)})}function v(e,t){return"svg"==t?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e)}t.logger||(t.logger=function(e,t){t||(t={}),e=e||"OI Logger";var i={};function s(){if(t.el){var e,s,n=!1,o=arguments[0],l=Array.prototype.shift.apply(arguments[1]),r=arguments[1]||{};if(r.length>0&&(r=r[r.length-1]),t.visible.includes(o)&&(n=!0),n)e="default",r.id&&(e=r.id),(s=document.getElementById(e))||((s=document.createElement("div")).classList.add("message",o),s.setAttribute("id",e)),t.class&&s.classList.add(...t.class.split(/ /)),s.innerHTML='<div class="message-inner">'+l.replace(/\%c/g,"")+"</div>",s.style.display=l?"":"none",t.el.prepend(s),(o=document.createElement("div")).setAttribute("tabindex",0),o.classList.add("close"),o.innerHTML="&times;",o.addEventListener("click",function(t){clearTimeout(i[e]),s.remove()}),s.appendChild(o),i[e]=setTimeout(function(){s.remove()},"number"==typeof r.fade?r.fade:"number"==typeof t.fade?t.fade:1e4)}}function n(){var t=Array.prototype.slice.call(arguments[0],0),i="string"==typeof t[0]?t[0]:"",s=["%c"+e+"%c: "+i.replace(/<[^\>]*>/g,""),"font-weight:bold;",""],n=i?1:0;return t.length>n?s.concat(t.splice(n)):s}return this.logging=location.search.indexOf("debug=true")>=0,console&&"function"==typeof console.log&&(this.log=function(){this.logging&&(console.log.apply(null,n(arguments)),s("log",arguments))},this.info=function(){console.info.apply(null,n(arguments)),s("info",arguments)},this.warn=function(){console.warn.apply(null,n(arguments)),s("warning",arguments)},this.error=function(){console.error.apply(null,n(arguments)),s("error",arguments)}),this.remove=function(e){var s=t.el.querySelector("#"+e);i[e]&&clearTimeout(i[e]),s&&s.remove()},this}),t.HexBuilder=function(e){return new n(e)},e.OI=t||e.OI||{}}(window||this);